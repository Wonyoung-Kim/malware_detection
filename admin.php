<?php
	require_once 'login.php';
	echo <<<_START
		<a href="index.php"><h3>Back to User Page</h3></a> <br> <br>
		<form method='post' action='admin.php' enctype='multipart/form-data' >
			Input File: <input type='file' name='fileupload' size='10' ><br>
			Name: <input type="text" name="filename">
			<input type='submit' value='Upload'>
		</form>
_START;
if (!$conn) {
	die(mysql_fatal_error());
  }
  //A. Checking if there are input
if (isset($_SERVER['PHP_AUTH_USER']) && isset($_SERVER['PHP_AUTH_PW'])) {
	$input_username = sanitizeMySQL($conn, $_SERVER['PHP_AUTH_USER']);
	$query = "SELECT * FROM admins WHERE username='$input_username'";
	$result = $conn->query($query);
	if(!$result) {
		die("Invalid username / password combination");
	}
	$salt1;
	$salt2;
	$hashtoken;
	$token;
	$admin_DB;
	$rows = $result->num_rows;
		for($i = 0; $i < $rows; $i++){
			$result->data_seek($i);
			$row = $result->fetch_array(MYSQLI_ASSOC);
			$salt1 = $row['salt1'];
			$salt2 = $row['salt2'];
			$admin_DB = $row['username'];
			$hashtoken = $row['passhash'];
			$result->close();
		}
		$password = sanitizeMySQL($conn, $_SERVER['PHP_AUTH_PW']);
		$token = hash('ripemd128', $salt1.$password.$salt2);
		//B. checking if input is matched with one in db
	if ($admin_DB == $input_username && $token == $hashtoken) {
		if($_FILES){
			$type = $_FILES['fileupload']['type'];
			$file_name = sanitizeMySQL($conn, $_POST["filename"]);
			if($type == "text/plain" && $file_name != "") {
				$name = sanitizeMySQL($conn, $_FILES['fileupload']['name']);
				$fh = fopen($name, 'r') or die("File Does not exist");
				$content = sanitizeMySQL($conn, file_get_contents($name, FALSE, NULL, 0, 20));
				fclose($fh);
				$query = "INSERT INTO malwareFiles (filename, malwarecontent) VALUES ('$file_name', '$content')";
				$result = $conn->query($query);
				if (!$result) {
					die(mysql_fatal_error());
				} else {
					echo "Malware File Uploaded! <br>";
				}
				$result->close();
				$conn->close();	
			} else {
				echo "ONLY txt files are allowed Or You need to name malware. <br>";
			}
		}	// B.
	} else die("WRONG username/password");
} else { // A.
	header('WWW-Authenticate: Basic realm="Restricted Section"');
	header("HTTP/1.0 401 Unauthorized");
	die ("Input right username AND password");
} 
function sanitizeString ($val) {
	$val = stripslashes($val);
	$val = strip_tags($val);
	$val = htmlentities($val);
	return $val;
}
function sanitizeMySQL($conn, $val) {
	$val = $conn->real_escape_string($val);
	$val = sanitizeString($val);
	return $val;
}
function mysql_fatal_error(){
	echo "Error";
}
?>
