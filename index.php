<?php
    echo <<<_END
            <a href="admin.php"><h1>Admin Log In</h1></a> <br> <br>
            <form method='post' action='index.php' enctype='multipart/form-data' >
                Malware Tester: <input type='file' name='uploadfile'>
                <input type='submit'>
            </form>
_END;
if($_FILES){
    require_once 'login.php';
    if (!$conn) {
        die(mysql_fatal_error());
    }
    define("MALWARE_SENSOR" ,20);
    $type = $_FILES['uploadfile']['type'];
    $size = $_FILES['uploadfile']['size'];
    $is_virus = true;
    $maxsize = 2097152;
if ($size < $maxsize) {
    if($type == "text/plain") {
        $content = sanitizeMySQL($conn, $_FILES['uploadfile']['name']);
        $query = "SELECT * FROM malwareFiles";
        $result = $conn->query($query);
        $rows = $result->num_rows;
        $malware_content = "";
        for ($i = 0; $i < $rows; $i++) {
            $result->data_seek($i);
            $row = $result->fetch_array(MYSQLI_ASSOC);
            $malware_content = $row['malwarecontent'];
            $name_virus = $row['filename'];
            $identical_byte = 0;
            $fh = fopen($content, 'r') or die("File Does not exist");
            //checking the bytes [0-19], then [1-20], then [2-21], and so on.
			while (!feof($fh)) {
				if (fread($fh, 1) === $malware_content[$identical_byte]) {
                    $identical_byte++;
					if ($identical_byte == MALWARE_SENSOR) { 
                        echo "This file contains malware! The type of malware is $name_virus";
                        $is_virus = false;
                        break 2;
					}
				} else {
					$identical_byte = 0;
				}
			}
            fclose($fh);
        }
        if ($is_virus) {
            echo "This file DOES NOT contain malware";
        }
        $result->close();
        $conn->close();
    } else {
        echo  "ONLY TEXT files are allowed <br>";
    }
} else {
    echo "Input file size is too big <br>";
}
}
function sanitizeString ($val) {
    $val = stripslashes($val);
    $val = strip_tags($val);
    $val = htmlentities($val);
    return $val;
}
function sanitizeMySQL($conn, $val) {
	$val = $conn->real_escape_string($val);
	$val = sanitizeString($val);
	return $val;
}
function mysql_fatal_error(){
    echo "Error";
}
?>
